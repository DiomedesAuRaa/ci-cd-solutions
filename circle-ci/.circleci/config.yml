version: 2.1

executors:
  terraform:
    docker:
      - image: hashicorp/terraform:1.9.8
    environment:
      TF_IN_AUTOMATION: "true"

jobs:
  terraform-plan:
    executor: terraform
    steps:
      - checkout
      - run:
          name: "Initialize Terraform"
          command: |
            terraform init \
              -backend-config="storage_account_name=${TF_STATE_STORAGE_ACCOUNT}" \
              -backend-config="container_name=${TF_STATE_CONTAINER}" \
              -backend-config="key=${TF_STATE_KEY}" \
              -backend-config="resource_group_name=tfstate-rg"
      - run:
          name: "Validate Terraform Configuration"
          command: terraform validate
      - run:
          name: "Plan Terraform Configuration"
          command: terraform plan -out=tfplan
      - persist_to_workspace:
          root: .
          paths:
            - .
            - .terraform
            - tfplan

  terraform-apply:
    executor: terraform
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Apply Terraform Configuration"
          command: terraform apply -auto-approve tfplan

  terraform-destroy:
    executor: terraform
    steps:
      - checkout
      - run:
          name: "Initialize Terraform"
          command: |
            terraform init \
              -backend-config="storage_account_name=${TF_STATE_STORAGE_ACCOUNT}" \
              -backend-config="container_name=${TF_STATE_CONTAINER}" \
              -backend-config="key=${TF_STATE_KEY}" \
              -backend-config="resource_group_name=tfstate-rg"
      - run:
          name: "Destroy Terraform Configuration"
          command: terraform destroy -auto-approve

workflows:
  version: 2
  terraform-deploy:
    jobs:
      - terraform-plan:
          context: terraform-aks-deploy
          filters:
            branches:
              only: main
      - hold:
          type: approval
          requires:
            - terraform-plan
      - terraform-apply:
          context: terraform-aks-deploy
          requires:
            - hold
  
  terraform-teardown:
    jobs:
      - hold-destroy:
          type: approval
          filters:
            branches:
              only: main
      - terraform-destroy:
          context: terraform-aks-deploy
          requires:
            - hold-destroy