name: 'Destroy GKE Terraform Configuration'

on:
  workflow_dispatch:  # Manual trigger to destroy infrastructure  

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-gke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terraform:
    name: 'Terraform Destroy'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clone External Terraform Repository
      run: |
        git clone https://github.com/DiomedesAuRaa/gcp-terraform-stack.git

    - name: Verify Cloned Files
      run: ls -la gcp-terraform-stack/gke

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: latest

    - name: Create terraform.tfvars
      working-directory: gcp-terraform-stack/gke
      run: |
        cat > terraform.tfvars <<EOF
        project_id = "${{ secrets.GCP_PROJECT_ID }}"
        region     = "${{ secrets.GCP_REGION || 'us-central1' }}"
        EOF

    - name: Terraform Init
      working-directory: gcp-terraform-stack/gke
      run: terraform init
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}

    - name: Terraform Plan (Destroy)
      working-directory: gcp-terraform-stack/gke
      run: terraform plan -destroy -out=tfplan
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}

    - name: Show Terraform Plan Output (Debugging)
      if: failure()
      working-directory: gcp-terraform-stack/gke
      run: |
        echo "Terraform destroy plan failed, printing debug information..."
        terraform plan -destroy

    - name: Terraform Apply (Destroy)
      working-directory: gcp-terraform-stack/gke
      run: terraform apply -auto-approve tfplan
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
